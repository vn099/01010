<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>60 dãy A – Mask 5 bit (logic mới)</title>

<style>
body { font-family: Arial, sans-serif; padding: 10px; }
table { border-collapse: collapse; width: 100%; max-width: 1800px; }
th, td { border: 1px solid #ccc; padding: 4px; text-align: center; }

input.bit {
  width: 30px;
  height: 36px;
  font-size: 18px;
  text-align: center;
  margin: 0 6px;
  background-color: yellow;
  border: 1px solid #999;
  border-radius: 8px;
  font-weight: bold;
}

input.bit.c-bit {
  cursor: default;
}

.bit-box {
  display: inline-block;
  width: 26px;
}

.changed {
  background: #ff4d4d;
  color: #fff;
  font-weight: bold;
}

textarea.row-output {
  width: 150px;
  height: 32px;
  resize: none;
  font-family: monospace;
  font-size: 14px;
}

button {
  margin: 6px 6px 12px 0;
  padding: 8px 20px;
  font-size: 16px;
}
</style>
</head>

<body>

<h3>60 dãy A (5 bit) – Mask sau sửa dùng A hàng sau</h3>

<button onclick="copyAll()">Copy const FINAL_MASKS</button>
<button onclick="resetAll()">Reset</button>

<table>
<thead>
<tr>
  <th>#</th>
  <th>Nhập 5 bit trước đó @-@</th>
  <th>Mask ban đầu</th>
  <th>Play in here !!!</th>
  <th>Mask sau sửa</th>
  <th>Chuỗi mask</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<script>
/* ===== MASK BAN ĐẦU ===== */
const MASKS = [
  "10101","01010","11000","00111","10010","01101",
  "11100","00011","10110","01001","11010","00101",
  "10001","01110","11101","00010","10100","01011",
  "11001","00110","10011","01100","11110","00001",
  "10111","01000","11011","00100","10000","01111",
  "11111","00000","10101","01010","11000","00111",
  "10010","01101","11100","00011","10110","01001",
  "11010","00101","10001","01110","11101","00010",
  "10111","01000","11011","00100","10000","01111",
  "11111","00000","10101","01010","11000","00111"
];

const FINAL_MASKS = Array(60).fill(null);
const tbody = document.getElementById("rows");

/* ===== TẠO BẢNG ===== */
for (let i = 0; i < 60; i++) {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${i + 1}</td>

    <td>
      ${Array(5).fill(0).map(() =>
        `<input class="bit" maxlength="1"
          inputmode="numeric" pattern="[01]"
          oninput="handleInput(this)">`
      ).join("")}
    </td>

    <td>${MASKS[i].split("").map(b =>
      `<span class="bit-box">${b}</span>`
    ).join("")}</td>

    <td id="c-${i}">
      ${Array(5).fill(0).map(() =>
        `<input class="bit c-bit" readonly>`
      ).join("")}
    </td>

    <td id="out-${i}"></td>

    <td>
      <textarea class="row-output" id="txt-${i}" readonly></textarea>
    </td>
  `;
  tbody.appendChild(tr);
}

/* ===== INPUT A ===== */
function handleInput(el) {
  el.value = el.value.replace(/[^01]/g, "");

  const row = el.closest("tr");
  const inputs = [...row.querySelectorAll("td:nth-child(2) input.bit")];
  const idx = inputs.indexOf(el);

  // focus ô tiếp theo trong cùng hàng
  if (el.value && idx < inputs.length - 1) {
    inputs[idx + 1].focus();
  }

  // nếu đủ 5 bit → tính & nhảy sang hàng dưới
  if (inputs.every(i => i.value !== "")) {
    calculateRow(row);

    const nextRow = row.nextElementSibling;
    if (nextRow) {
      const firstInputNextRow =
        nextRow.querySelector("td:nth-child(2) input.bit");
      firstInputNextRow?.focus();
    }
  }
}

/* ===== TÍNH HÀNG ===== */
function calculateRow(row) {
  const idx = row.rowIndex - 1;

  const A = [...row.querySelectorAll("td:nth-child(2) input.bit")]
            .map(i => +i.value);

  const baseMask = MASKS[idx].split("").map(Number);

  /* --- C HIỂN THỊ --- */
  const C_display = A.map((b, i) => b ^ baseMask[i]);
  row.querySelectorAll(".c-bit").forEach((el, i) => {
    el.value = C_display[i];
    el.style.color = C_display[i] ? "red" : "#0096c7";
  });

  /* --- MASK SAU SỬA (DÙNG A HÀNG SAU) --- */
  let newMask = baseMask.slice();
  let changed = [];

  if (idx < 59) {
    const nextRow = tbody.rows[idx + 1];
    const A_next = [...nextRow.querySelectorAll("td:nth-child(2) input.bit")]
                    .map(i => i.value === "" ? 0 : +i.value);

    let C_for_mask = A_next.map((b, i) => b ^ newMask[i]);
    let ones = C_for_mask.map((v, i) => v === 1 ? i : -1).filter(i => i !== -1);

    while (ones.length > 2) {
      const pos = ones[Math.floor(Math.random() * ones.length)];
      newMask[pos] ^= 1;
      C_for_mask[pos] ^= 1;
      changed.push(pos);
      ones = ones.filter(i => i !== pos);
    }
  }

  FINAL_MASKS[idx] = newMask.slice();

  row.querySelector(`#out-${idx}`).innerHTML =
    newMask.map((b, i) =>
      `<span class="bit-box ${changed.includes(i) ? 'changed' : ''}">${b}</span>`
    ).join("");

  document.getElementById(`txt-${idx}`).value =
    `[${newMask.join(",")}],`;
}

/* ===== COPY ===== */
function copyAll() {
  if (FINAL_MASKS.some(v => v === null)) {
    alert("Chưa đủ 60 mask");
    return;
  }

  const text =
`const FINAL_MASKS = [
${FINAL_MASKS.map(m => `  [${m.join(",")}],`).join("\n")}
];`;

  navigator.clipboard.writeText(text);
  alert("Đã copy FINAL_MASKS");
}

/* ===== RESET ===== */
function resetAll() {
  document.querySelectorAll("input.bit").forEach(i => i.value = "");
  document.querySelectorAll(".c-bit").forEach(i => i.value = "");
  document.querySelectorAll("td[id^='out-']").forEach(td => td.innerHTML = "");
}
</script>

</body>
</html>

